---
name: RLP
category: 
---

Цель RLP (Recursive Length Prefix) - кодировка произвольных вложенных списков бинарных данных. RLP используется как основной метод сериализации объектов в Ethereum'е. Единственная задача RLP - кодировка структур, кодировкой конкретных атомарных типов данных (строк, целых чисел, чисел с плавающей запятой и др.) должны заниматься протоколы более высокого уровня. В Ethereum'е целые числа должны быть представлены в бинарном виде с порядком байтов от старшего к младшему (таким образом, значение 0 эквивалентно пустому списку байтов).

Если есть необходимость в кодировке словаря, предлагается использовать один из двух канонических способов: `[[k1,v1],[k2,v2]...]` с ключами в лексикографическом порядке или [Patricia Tree](https://github.com/ethereum/wiki/wiki/Patricia-Tree), как это делает Ethereum.

### Определение

Функция кодировки RLP принимает на вход объект. Объект определяется следующим образом:

* Строка (список байтов) является объектом
* Список объектов является объектом

Для примера, пустая строка - это объект, точно также, как и строка "cat". Более сложные структуры данных такие, как `["cat",["puppy","cow"],"horse",[[]],"pig",[""],"sheep"]`, тоже являются объектами. Нужно обратить внимание, что в контексте данной статьи понятие "строка" используется как "некоторое число байтов бинарных данных"; никакой информации о специальной кодировке и содержании строки не подразумевается.

RLP кодировка определяется следующим образом:

* Единичный байт, чье значение в пределах `[0x00, 0x7f]`, является своей RLP кодировкой.
* В противном случае, если строка длины 0-55 байтов, ее RLP кодировка состоит из одного байта со значением **0x80** плюс длина данной строки, затем следует сама строка. Таким образом, интервал, в который входит первый байт `[0x80, 0xb7]`.
* Если строка большей длины, чем 55 байтов, ее RLP кодировка состоит из одного байта со значением **0xb7** плюс длина строки, которая является бинарным представлением длины исходной строки, затем следует бинарное представление длины строки и сама исходная строка. Таким образом, первой байт входит в интервал `[0xb8, 0xbf]`.
* Если конкатенация всех закодированных объектов списка имеет длину 0-55 байтов, то кодировка данного списка состоит из одного байта со значением **0xc0** плюс длина конкатенации, затем следует сама конкатенация. Таким образом, интервал, в который входит первый байт `[0xc0, 0xf7]`.
* Если длина конкатенации всех закодированных объектов списка больше 55 байтов, RLP кодировка состоит из одного байта **0xf7** плюс длина строки, которая является бинарным представлением длины конкатенации, затем следует бинарное представление длины конкатенации и сама конкатенация. Таким образом, интервал, в который входит первый байт `[0xf8, 0xff]`.

В коде:

```python
def rlp_encode(input):
    if isinstance(input,str):
        if len(input) == 1 and chr(input) < 128: return input
        else: return encode_length(len(input),128) + input
    elif isinstance(input,list):
        output = ''
        for item in input: output += rlp_encode(item)
        return encode_length(len(output),192) + output

def encode_length(L,offset):
    if L < 56:
         return chr(L + offset)
    elif L < 256**8:
         BL = to_binary(L)
         return chr(len(BL) + offset + 55) + BL
    else:
         raise Exception("input too long")

def to_binary(x):
    return '' if x == 0 else to_binary(int(x / 256)) + chr(x % 256)
```

### Примеры

Строка "dog" = [ 0x83, 'd', 'o', 'g' ]

Список [ "cat", "dog" ] = `[ 0xc8, 0x83, 'c', 'a', 't', 0x83, 'd', 'o', 'g' ]`

Пустая строка ('null') = `[ 0x80 ]`

Пустой список = `[ 0xc0 ]`

Закодированное целое число 15 ('\x0f') = `[ 0x0f ]`

Закодированное целое число 1024 ('\x04\x00') = `[ 0x82, 0x04, 0x00 ]`

[Теоретическое представление](http://en.wikipedia.org/wiki/Set-theoretic_definition_of_natural_numbers) числа 2, `[ [], [[]], [ [], [[]] ] ] = [ 0xc7, 0xc0, 0xc1, 0xc0, 0xc3, 0xc0, 0xc1, 0xc0 ]`

Строка "Lorem ipsum dolor sit amet, consectetur adipisicing elit" = `[ 0xb8, 0x38, 'L', 'o', 'r', 'e', 'm', ' ', ... , 'e', 'l', 'i', 't' ]`

